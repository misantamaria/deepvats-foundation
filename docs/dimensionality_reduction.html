---

title: Dimensionality reduction


keywords: fastai
sidebar: home_sidebar

summary: "This notebook gets the latent features from a multivariate time series "
description: "This notebook gets the latent features from a multivariate time series "
nb_path: "nbs/03_dimensionality_reduction.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_dimensionality_reduction.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Config-parameters">Config parameters<a class="anchor-link" href="#Config-parameters"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Put here everything that could be needed if this notebook</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span>
    <span class="n">use_wandb</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># Whether to use or not wandb for experiment tracking</span>
    <span class="n">wandb_group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Whether to group this run in a wandb group</span>
    <span class="n">wandb_entity</span> <span class="o">=</span> <span class="s1">&#39;pacmel&#39;</span><span class="p">,</span>
    <span class="n">wandb_project</span> <span class="o">=</span> <span class="s1">&#39;timecluster-extension&#39;</span><span class="p">,</span>
    <span class="n">dr_artifact_name</span> <span class="o">=</span> <span class="s1">&#39;JNK:v18&#39;</span><span class="p">,</span> <span class="c1"># * Set to None for using the default one (DCAE)</span>
    <span class="n">dcae_run_path</span><span class="o">=</span> <span class="s1">&#39;pacmel/timecluster-extension/48afdwny&#39;</span><span class="p">,</span> <span class="c1">#&#39;pacmel/timecluster-extension/red8g4bp&#39; # *</span>
    <span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="c1">#UMAP</span>
    <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="c1">#UMAP</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="c1">#UMAP</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># UMAP</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This model needs to restore the model fitted in the notebook <code>02_DCAE</code>, as well as the data and configuration</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Taking the best run from a sweep.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run">Run<a class="anchor-link" href="#Run"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_dr</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_entity</span><span class="p">,</span>
                    <span class="n">project</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_project</span><span class="p">,</span> 
                    <span class="n">group</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">wandb_group</span><span class="p">,</span>
                    <span class="n">allow_val_change</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                    <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;dimensionality_reduction&#39;</span><span class="p">,</span> 
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;online&#39;</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_wandb</span> <span class="k">else</span> <span class="s1">&#39;offline&#39;</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">config_dr</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">config</span> <span class="c1"># Object for storing hyperparameters</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre><span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Currently logged in as: <span class="ansi-yellow-fg">vrodriguezf</span> (use `wandb login --relogin` to force relogin)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

                Tracking run with wandb version 0.10.30<br/>
                Syncing run <strong style="color:#cdcd00">skilled-galaxy-504</strong> to <a href="https://wandb.ai" target="_blank">Weights & Biases</a> <a href="https://docs.wandb.com/integrations/jupyter.html" target="_blank">(Documentation)</a>.<br/>
                Project page: <a href="https://wandb.ai/pacmel/timecluster-extension" target="_blank">https://wandb.ai/pacmel/timecluster-extension</a><br/>
                Run page: <a href="https://wandb.ai/pacmel/timecluster-extension/runs/2wyslnnr" target="_blank">https://wandb.ai/pacmel/timecluster-extension/runs/2wyslnnr</a><br/>
                Run data is saved locally in <code>/home/victor/work/nbs/wandb/run-20210527_173412-2wyslnnr</code><br/><br/>
            
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Restore a DCAE model and its associated configuration</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dcae_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;model-best.h5&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_path</span><span class="o">=</span><span class="n">config_dr</span><span class="o">.</span><span class="n">dcae_run_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s1">&#39;config.yaml&#39;</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_path</span><span class="o">=</span><span class="n">config_dr</span><span class="o">.</span><span class="n">dcae_run_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">dcae_config</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">FullLoader</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Restore the dataset artifact used for creating the DCAE. Even if we do not compute the dimensionality reduction over this dataset,
we need to know the metadata of the dataset of the DCAE, to check that it matches with the dataset that we want to reduce.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dcae_artifact_type</span> <span class="o">=</span> <span class="n">dcae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ds_train_artifact_type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">dcae_artifact_name</span> <span class="o">=</span> <span class="n">dcae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ds_train_artifact_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">dcae_artifact_digest</span> <span class="o">=</span> <span class="n">dcae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ds_train_artifact_digest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
<span class="n">dcae_artifact_type</span><span class="p">,</span> <span class="n">dcae_artifact_name</span><span class="p">,</span> <span class="n">dcae_artifact_digest</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(&#39;dataset&#39;, &#39;JNK:v17&#39;, &#39;bc2c682a76fd28127848efd52c6a9d87&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dcae_artifact</span> <span class="o">=</span> <span class="n">run_dr</span><span class="o">.</span><span class="n">use_artifact</span><span class="p">(</span><span class="n">dcae_artifact_name</span><span class="p">)</span>
<span class="n">dcae_artifact</span><span class="o">.</span><span class="n">metadata</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;TS&#39;: {&#39;ed&#39;: &#39;2019-06-23 23:59:55&#39;,
  &#39;sd&#39;: &#39;2019-06-01 00:00:00&#39;,
  &#39;freq&#39;: &#39;&lt;5 * Seconds&gt;&#39;,
  &#39;hash&#39;: &#39;2649617295588873929&#39;,
  &#39;vars&#39;: [&#39;RCD_AverageThree-phaseCurrent&#39;,
   &#39;LCD_AverageThree-phaseCurrent&#39;,
   &#39;LP_AverageThree-phaseCurrent&#39;,
   &#39;LHD_LeftHaulageDrive(tractor)Temperature(gearbox)&#39;,
   &#39;RHD_RightHaulageDrive(tractor)Temperature(gearbox)&#39;,
   &#39;LA_LeftArmTemperature&#39;,
   &#39;RA_RightArmTemperature&#39;,
   &#39;SM_DailyRouteOfTheShearer&#39;,
   &#39;SM_TotalRoute&#39;,
   &#39;LHD_EngineCurrent&#39;,
   &#39;RHD_EngineCurrent&#39;,
   &#39;RCD_BearingTemperature&#39;,
   &#39;SM_ShearerSpeed&#39;,
   &#39;SM_ShearerLocation&#39;,
   &#39;SM_ShearerMoveInLeft&#39;,
   &#39;SM_ShearerMoveInRight&#39;],
  &#39;n_vars&#39;: 16,
  &#39;created&#39;: &#39;from-df&#39;,
  &#39;n_samples&#39;: 397440,
  &#39;normalization&#39;: {&#39;stds&#39;: {&#39;SM_TotalRoute&#39;: 21.992641402532836,
    &#39;SM_ShearerSpeed&#39;: 2.724568932534116,
    &#39;LHD_EngineCurrent&#39;: 21.62938860961895,
    &#39;RHD_EngineCurrent&#39;: 21.0185248258138,
    &#39;SM_ShearerLocation&#39;: 79.54958101088538,
    &#39;SM_ShearerMoveInLeft&#39;: 0.23984552514921795,
    &#39;LA_LeftArmTemperature&#39;: 11.703453684488062,
    &#39;SM_ShearerMoveInRight&#39;: 0.2740396394970838,
    &#39;RA_RightArmTemperature&#39;: 14.241837114195002,
    &#39;RCD_BearingTemperature&#39;: 16.38976490874,
    &#39;SM_DailyRouteOfTheShearer&#39;: 1041.6509027057057,
    &#39;LP_AverageThree-phaseCurrent&#39;: 2.602739399288098,
    &#39;LCD_AverageThree-phaseCurrent&#39;: 37.53576607948344,
    &#39;RCD_AverageThree-phaseCurrent&#39;: 37.94242587020688,
    &#39;LHD_LeftHaulageDrive(tractor)Temperature(gearbox)&#39;: 23.849734730214823,
    &#39;RHD_RightHaulageDrive(tractor)Temperature(gearbox)&#39;: 13.529230119837738},
   &#39;means&#39;: {&#39;SM_TotalRoute&#39;: 147.6549115589775,
    &#39;SM_ShearerSpeed&#39;: 0.959477657004831,
    &#39;LHD_EngineCurrent&#39;: 12.01001207729469,
    &#39;RHD_EngineCurrent&#39;: 11.658245018115943,
    &#39;SM_ShearerLocation&#39;: 107.85175322061193,
    &#39;SM_ShearerMoveInLeft&#39;: 0.06354418276972625,
    &#39;LA_LeftArmTemperature&#39;: 39.38937726449275,
    &#39;SM_ShearerMoveInRight&#39;: 0.08480525362318843,
    &#39;RA_RightArmTemperature&#39;: 43.229178995571665,
    &#39;RCD_BearingTemperature&#39;: 52.631301328502424,
    &#39;SM_DailyRouteOfTheShearer&#39;: 1025.0101570048312,
    &#39;LP_AverageThree-phaseCurrent&#39;: 1.782810990338164,
    &#39;LCD_AverageThree-phaseCurrent&#39;: 34.773016304347834,
    &#39;RCD_AverageThree-phaseCurrent&#39;: 35.77255963164252,
    &#39;LHD_LeftHaulageDrive(tractor)Temperature(gearbox)&#39;: 54.08012253421901,
    &#39;RHD_RightHaulageDrive(tractor)Temperature(gearbox)&#39;: 3.4972851247987125}},
  &#39;has_missing_values&#39;: &#39;False&#39;}}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we specify the dataset artifact that we want to use for the reduction. If no artifact is defined, the artifact to reduce will be the one used for training the DCAE.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">config_dr</span><span class="o">.</span><span class="n">dr_artifact_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dr_artifact</span> <span class="o">=</span> <span class="n">run_dr</span><span class="o">.</span><span class="n">use_artifact</span><span class="p">(</span><span class="n">config_dr</span><span class="o">.</span><span class="n">dr_artifact_name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dr_artifact</span> <span class="o">=</span> <span class="n">dcae_artifact</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we need to check whether the artifact that is going to be used fort the dimensionality reduction matches the artifact used to train the DCAE. Matching means having the same number of variables, the same window size and stride, and the same frequency.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_compatibility" class="doc_header"><code>check_compatibility</code><a href="https://gitlab.geist.re/pml/x_timecluster_extension/tree/master/timecluster_hub/dr.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_compatibility</code>(<strong><code>dr_ar</code></strong>:<a href="/timecluster_hub/load.html#TSArtifact"><code>TSArtifact</code></a>, <strong><code>dcae_ar</code></strong>:<a href="/timecluster_hub/load.html#TSArtifact"><code>TSArtifact</code></a>)</p>
</blockquote>
<p>Function to check that the artifact used by the DCAE and the artifact that is     going to be passed through the DR are compatible</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="normalize_artifact" class="doc_header"><code>normalize_artifact</code><a href="https://gitlab.geist.re/pml/x_timecluster_extension/tree/master/timecluster_hub/dr.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>normalize_artifact</code>(<strong><code>artifact</code></strong>:<a href="/timecluster_hub/load.html#TSArtifact"><code>TSArtifact</code></a>, <strong><code>artifact_norm</code></strong>:<a href="/timecluster_hub/load.html#TSArtifact"><code>TSArtifact</code></a>)</p>
</blockquote>
<p>Function to normalize an artifact with the normalization parameters of another     one</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">normalize_artifact</span><span class="p">(</span><span class="n">dr_artifact</span><span class="p">,</span> <span class="n">dcae_artifact</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Artifacts are compatible.
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RCD_AverageThree-phaseCurrent</th>
      <th>LCD_AverageThree-phaseCurrent</th>
      <th>LP_AverageThree-phaseCurrent</th>
      <th>LHD_LeftHaulageDrive(tractor)Temperature(gearbox)</th>
      <th>RHD_RightHaulageDrive(tractor)Temperature(gearbox)</th>
      <th>LA_LeftArmTemperature</th>
      <th>RA_RightArmTemperature</th>
      <th>SM_DailyRouteOfTheShearer</th>
      <th>SM_TotalRoute</th>
      <th>LHD_EngineCurrent</th>
      <th>RHD_EngineCurrent</th>
      <th>RCD_BearingTemperature</th>
      <th>SM_ShearerSpeed</th>
      <th>SM_ShearerLocation</th>
      <th>SM_ShearerMoveInLeft</th>
      <th>SM_ShearerMoveInRight</th>
    </tr>
    <tr>
      <th>TIMESTAMP</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2019-06-24 00:00:00</th>
      <td>-0.626543</td>
      <td>-0.638671</td>
      <td>-0.684975</td>
      <td>-1.261235</td>
      <td>-0.258498</td>
      <td>-1.400388</td>
      <td>-1.420405</td>
      <td>-0.981145</td>
      <td>1.211546</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-1.563860</td>
      <td>-0.352158</td>
      <td>-0.563821</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-24 00:00:05</th>
      <td>-0.626543</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>-1.261235</td>
      <td>-0.258498</td>
      <td>-1.400388</td>
      <td>-1.420405</td>
      <td>-0.984025</td>
      <td>1.211546</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-1.563860</td>
      <td>-0.352158</td>
      <td>-0.563821</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-24 00:00:10</th>
      <td>-0.626543</td>
      <td>-0.638671</td>
      <td>-0.684975</td>
      <td>-1.261235</td>
      <td>-0.258498</td>
      <td>-1.400388</td>
      <td>-1.420405</td>
      <td>-0.984025</td>
      <td>1.211546</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-1.563860</td>
      <td>-0.352158</td>
      <td>-0.563821</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-24 00:00:15</th>
      <td>-0.626543</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>-1.261235</td>
      <td>-0.258498</td>
      <td>-1.400388</td>
      <td>-1.420405</td>
      <td>-0.984025</td>
      <td>1.211546</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-1.563860</td>
      <td>-0.352158</td>
      <td>-0.563821</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-24 00:00:20</th>
      <td>-0.626543</td>
      <td>-0.644000</td>
      <td>-0.684975</td>
      <td>-1.261235</td>
      <td>-0.258498</td>
      <td>-1.400388</td>
      <td>-1.420405</td>
      <td>-0.984025</td>
      <td>1.211546</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-1.563860</td>
      <td>-0.352158</td>
      <td>-0.563821</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2019-06-28 23:59:40</th>
      <td>-0.600187</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>0.667508</td>
      <td>-0.258498</td>
      <td>0.479399</td>
      <td>0.334986</td>
      <td>1.597454</td>
      <td>1.984531</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-0.099532</td>
      <td>-0.352158</td>
      <td>0.466982</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-28 23:59:45</th>
      <td>-0.600187</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>0.667508</td>
      <td>-0.258498</td>
      <td>0.479399</td>
      <td>0.334986</td>
      <td>1.597454</td>
      <td>1.984531</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-0.099532</td>
      <td>-0.352158</td>
      <td>0.466982</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-28 23:59:50</th>
      <td>-0.600187</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>0.667508</td>
      <td>-0.258498</td>
      <td>0.479399</td>
      <td>0.334986</td>
      <td>1.597454</td>
      <td>1.984531</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-0.099532</td>
      <td>-0.352158</td>
      <td>0.466982</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-28 23:59:55</th>
      <td>-0.600187</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>0.667508</td>
      <td>-0.258498</td>
      <td>0.479399</td>
      <td>0.334986</td>
      <td>1.597454</td>
      <td>1.984531</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-0.099532</td>
      <td>-0.352158</td>
      <td>0.466982</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
    <tr>
      <th>2019-06-29 00:00:00</th>
      <td>-0.600187</td>
      <td>-0.633343</td>
      <td>-0.684975</td>
      <td>0.667508</td>
      <td>-0.258498</td>
      <td>0.479399</td>
      <td>0.334986</td>
      <td>-0.984025</td>
      <td>1.984531</td>
      <td>-0.555264</td>
      <td>-0.554665</td>
      <td>-0.099532</td>
      <td>-0.352158</td>
      <td>0.466982</td>
      <td>-0.264938</td>
      <td>-0.309463</td>
    </tr>
  </tbody>
</table>
<p>86401 rows × 16 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(86401, 16)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dcae_input</span> <span class="o">=</span> <span class="n">df_slicer</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                       <span class="n">w</span><span class="o">=</span><span class="n">dcae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
                       <span class="n">s</span><span class="o">=</span><span class="n">dcae_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stride&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
<span class="n">dcae_input</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(12330, 96, 16)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Getting-the-latent-variables-from-the-trained-model">Getting the latent variables from the trained model<a class="anchor-link" href="#Getting-the-latent-variables-from-the-trained-model"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once the DCAE model is trained, we are interested in the information contained in the <strong>Dense</strong> layer (also called <em>bottleneck</em>)for each slice of data. To do that, we have to call the <code>predict</code> function on an intermediate model that gets the output of the intermediate layer.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_latent_features" class="doc_header"><code>get_latent_features</code><a href="https://gitlab.geist.re/pml/x_timecluster_extension/tree/master/timecluster_hub/dcae.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_latent_features</code>(<strong><code>dcae</code></strong>, <strong><code>input_data</code></strong>, <strong><code>bottleneck_ln</code></strong>=<em><code>'latent_features'</code></em>)</p>
</blockquote>
<p>Get the activations of the bottleneck layer within the fitted autoencoder <code>dcae</code> (a Keras model)     for the input data <code>input_data</code> (a tensor). The name of the bottleneck layer is given in `bottleneck_ln</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">intermediate_prediction</span> <span class="o">=</span> <span class="n">get_latent_features</span><span class="p">(</span><span class="n">dcae_model</span><span class="p">,</span> <span class="n">dcae_input</span><span class="p">,</span> <span class="s1">&#39;latent_features&#39;</span><span class="p">)</span>
<span class="n">intermediate_prediction</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(12330, 96)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Dimensionality-reduction-using-UMAP">Dimensionality reduction using UMAP<a class="anchor-link" href="#Dimensionality-reduction-using-UMAP"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We use DR techniques to provide an alternative view for users to visually analyze and explore the time-series data. The algorithm UMAP shows its high competitiveness compared to t-SNE. t-SNE suffers from some limitations such as loss of large-scale information (the inter-cluster relationships). UMAP has a faster runtime and provides better scaling which helps to gain a meaningful organization of clusters, outliers and the preservation of continuums compared to t-SNE</p>
<p>For this part of the implementation, the package <a href="https://github.com/lmcinnes/umap">umap-learn</a> is used. The input of the algoritm is the $n \times \delta$ that contains, for each slice of the time series, the corresponding $\delta$ latent features given by the DCAE.</p>
<p>The hyperparameters of UMAP are given values by default here. If the value has been already set previously, that means this notebook is being called from a wandb sweep, and we must use the value that the sweep is bringing.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">umap_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;n_neighbors&#39;</span> <span class="p">:</span> <span class="n">config_dr</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">,</span>
    <span class="s1">&#39;min_dist&#39;</span> <span class="p">:</span> <span class="n">config_dr</span><span class="o">.</span><span class="n">min_dist</span><span class="p">,</span>
    <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="n">config_dr</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">True</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finall, we gather all this functionality into a function for future use</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fget_UMAP_embeddings" class="doc_header"><code>fget_UMAP_embeddings</code><a href="https://gitlab.geist.re/pml/x_timecluster_extension/tree/master/timecluster_hub/dr.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fget_UMAP_embeddings</code>(<strong><code>input_data</code></strong>, <strong><code>n_neighbors</code></strong>=<em><code>15</code></em>, <strong><code>n_components</code></strong>=<em><code>2</code></em>, <strong><code>metric</code></strong>=<em><code>'euclidean'</code></em>, <strong><code>metric_kwds</code></strong>=<em><code>None</code></em>, <strong><code>output_metric</code></strong>=<em><code>'euclidean'</code></em>, <strong><code>output_metric_kwds</code></strong>=<em><code>None</code></em>, <strong><code>n_epochs</code></strong>=<em><code>None</code></em>, <strong><code>learning_rate</code></strong>=<em><code>1.0</code></em>, <strong><code>init</code></strong>=<em><code>'spectral'</code></em>, <strong><code>min_dist</code></strong>=<em><code>0.1</code></em>, <strong><code>spread</code></strong>=<em><code>1.0</code></em>, <strong><code>low_memory</code></strong>=<em><code>True</code></em>, <strong><code>n_jobs</code></strong>=<em><code>-1</code></em>, <strong><code>set_op_mix_ratio</code></strong>=<em><code>1.0</code></em>, <strong><code>local_connectivity</code></strong>=<em><code>1.0</code></em>, <strong><code>repulsion_strength</code></strong>=<em><code>1.0</code></em>, <strong><code>negative_sample_rate</code></strong>=<em><code>5</code></em>, <strong><code>transform_queue_size</code></strong>=<em><code>4.0</code></em>, <strong><code>a</code></strong>=<em><code>None</code></em>, <strong><code>b</code></strong>=<em><code>None</code></em>, <strong><code>random_state</code></strong>=<em><code>None</code></em>, <strong><code>angular_rp_forest</code></strong>=<em><code>False</code></em>, <strong><code>target_n_neighbors</code></strong>=<em><code>-1</code></em>, <strong><code>target_metric</code></strong>=<em><code>'categorical'</code></em>, <strong><code>target_metric_kwds</code></strong>=<em><code>None</code></em>, <strong><code>target_weight</code></strong>=<em><code>0.5</code></em>, <strong><code>transform_seed</code></strong>=<em><code>42</code></em>, <strong><code>transform_mode</code></strong>=<em><code>'embedding'</code></em>, <strong><code>force_approximation_algorithm</code></strong>=<em><code>False</code></em>, <strong><code>verbose</code></strong>=<em><code>False</code></em>, <strong><code>unique</code></strong>=<em><code>False</code></em>, <strong><code>densmap</code></strong>=<em><code>False</code></em>, <strong><code>dens_lambda</code></strong>=<em><code>2.0</code></em>, <strong><code>dens_frac</code></strong>=<em><code>0.3</code></em>, <strong><code>dens_var_shift</code></strong>=<em><code>0.1</code></em>, <strong><code>output_dens</code></strong>=<em><code>False</code></em>, <strong><code>disconnection_distance</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Compute the embeddings of <code>input_data</code> using UMAP, with a configuration contained in <code>**kwargs</code>.     Returns also information of the reducer.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">embeddings</span><span class="p">,</span> <span class="n">reducer</span> <span class="o">=</span> <span class="n">fget_UMAP_embeddings</span><span class="p">(</span><span class="n">intermediate_prediction</span><span class="p">,</span> <span class="o">**</span><span class="n">umap_params</span><span class="p">)</span>
<span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>UMAP(dens_frac=0.0, dens_lambda=0.0, verbose=True)
Construct fuzzy simplicial set
Fri May 21 14:40:05 2021 Finding Nearest Neighbors
Fri May 21 14:40:05 2021 Building RP forest with 11 trees
Fri May 21 14:40:09 2021 NN descent for 14 iterations
	 1  /  14
	 2  /  14
	 3  /  14
	 4  /  14
	Stopping threshold met -- exiting after 4 iterations
Fri May 21 14:40:25 2021 Finished Nearest Neighbor Search
Fri May 21 14:40:27 2021 Construct embedding
	completed  0  /  200 epochs
	completed  20  /  200 epochs
	completed  40  /  200 epochs
	completed  60  /  200 epochs
	completed  80  /  200 epochs
	completed  100  /  200 epochs
	completed  120  /  200 epochs
	completed  140  /  200 epochs
	completed  160  /  200 epochs
	completed  180  /  200 epochs
Fri May 21 14:40:37 2021 Finished embedding
CPU times: user 4min 52s, sys: 48.7 s, total: 5min 41s
Wall time: 32.4 s
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(12330, 2)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="n">intermediate_prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reducer</span><span class="o">.</span><span class="n">n_components</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">reducer</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">umap_params</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Save the embeddings as an artifact</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">timecluster_extension.utils</span> <span class="kn">import</span> <span class="n">ReferenceArtifact</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embeddings_ar</span> <span class="o">=</span> <span class="n">ReferenceArtifact</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;embeddings&#39;</span><span class="p">)</span>
<span class="n">embeddings_ar</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">embeddings_ar</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>({&#39;ref&#39;: {&#39;hash&#39;: &#39;-7137006075972365459&#39;, &#39;type&#39;: &#34;&lt;class &#39;numpy.ndarray&#39;&gt;&#34;}},
 dict_values([&lt;ManifestEntry ref: file:///home/victor/data/PACMEL-2019/wandb_artifacts/-7137006075972365459/-7137006075972365459&gt;]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_dr</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">embeddings_ar</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;timecluster_extension.utils.ReferenceArtifact at 0x7f2d4847e640&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embeddings_ar</span><span class="o">.</span><span class="n">digest</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-79-a511b58fb399&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>embeddings_ar<span class="ansi-blue-fg">.</span>digest

<span class="ansi-green-fg">/usr/local/lib/python3.8/dist-packages/wandb/sdk/wandb_artifacts.py</span> in <span class="ansi-cyan-fg">digest</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    179</span>     <span class="ansi-green-fg">def</span> digest<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> str<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    180</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_logged_artifact<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 181</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_logged_artifact<span class="ansi-blue-fg">.</span>digest
<span class="ansi-green-intense-fg ansi-bold">    182</span> 
<span class="ansi-green-intense-fg ansi-bold">    183</span>         self<span class="ansi-blue-fg">.</span>finalize<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.8/dist-packages/wandb/sdk/wandb_artifacts.py</span> in <span class="ansi-cyan-fg">digest</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    178</span>     <span class="ansi-blue-fg">@</span>property
<span class="ansi-green-intense-fg ansi-bold">    179</span>     <span class="ansi-green-fg">def</span> digest<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> str<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 180</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_logged_artifact<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    181</span>             <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_logged_artifact<span class="ansi-blue-fg">.</span>digest
<span class="ansi-green-intense-fg ansi-bold">    182</span> 

<span class="ansi-green-fg">/usr/local/lib/python3.8/dist-packages/wandb/sdk/wandb_run.py</span> in <span class="ansi-cyan-fg">__getattr__</span><span class="ansi-blue-fg">(self, item)</span>
<span class="ansi-green-intense-fg ansi-bold">   2391</span>     <span class="ansi-green-fg">def</span> __getattr__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> item<span class="ansi-blue-fg">:</span> str<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> Any<span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">   2392</span>         <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>_instance<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 2393</span><span class="ansi-red-fg">             raise ValueError(
</span><span class="ansi-green-intense-fg ansi-bold">   2394</span>                 <span class="ansi-blue-fg">&#34;Must call wait() before accessing logged artifact properties&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   2395</span>             )

<span class="ansi-red-fg">ValueError</span>: Must call wait() before accessing logged artifact properties</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config_dr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
          <span class="s1">&#39;emb_artifact_type&#39;</span><span class="p">:</span> <span class="n">embeddings_ar</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
          <span class="s1">&#39;emb_artifact_name&#39;</span><span class="p">:</span> <span class="n">embeddings_ar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="s1">&#39;emb_artifact_digest&#39;</span><span class="p">:</span> <span class="n">embeddings_ar</span><span class="o">.</span><span class="n">digest</span>
    <span class="p">},</span> 
    <span class="n">allow_val_change</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-Precompudet-Clusters">Create Precompudet Clusters<a class="anchor-link" href="#Create-Precompudet-Clusters"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to integrate precomputed clusters into the embedding space, it's necessary to log artifacts that include the labels of the newly created clusters.</p>
<p>The cluster creation process is presented below. This creation procedure can be modified according to specific needs. However, the structure of the new artifact must be preserved (it must be a numpy.ndarray and the number of elements must be equal to the number of points in the embedding space).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HDBSCAN supported metrics: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">hdbscan</span><span class="o">.</span><span class="n">dist_metrics</span><span class="o">.</span><span class="n">METRIC_MAPPING</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdbscan_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;min_cluster_size&#39;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s1">&#39;min_samples&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s1">&#39;cluster_selection_epsilon&#39;</span> <span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">metric_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="s1">&#39;jaccard&#39;</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clusters</span> <span class="o">=</span> <span class="n">hdbscan</span><span class="o">.</span><span class="n">HDBSCAN</span><span class="p">(</span><span class="o">**</span><span class="n">hdbscan_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
<span class="n">clusters_labels</span> <span class="o">=</span> <span class="n">clusters</span><span class="o">.</span><span class="n">labels_</span>
<span class="n">clusters_labels</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq_type</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">clusters_labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">clusters_labels</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clusters_ar</span> <span class="o">=</span> <span class="n">ReferenceArtifact</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">clusters_labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;clusters_labels&#39;</span><span class="p">)</span>
<span class="n">clusters_ar</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">clusters_ar</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_dr</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">clusters_ar</span><span class="p">,</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hdbscan_jaccard&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2D-Visualization">2D Visualization<a class="anchor-link" href="#2D-Visualization"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>While the connected scatter plot is a simple visualization technique, it has very specific functions in our approach. Every sliding window is represented as a dot in the plot after the projection process (Fig. 4C, D of the paper). Before labeling, all points have the same color and transparency, and when they are concentrated in one area, the densities are accumulated. Lines are used to connect consecutive points preserving the temporal ordering of the data and allowing the user to see temporal connections (Fig. 4B of the paper). Thus, the point is linked to the previous point (inner) and to the posterior point (outer) as an indication of the flow of time.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="plot_embeddings" class="doc_header"><code>plot_embeddings</code><a href="https://gitlab.geist.re/pml/x_timecluster_extension/tree/master/timecluster_hub/dr.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>plot_embeddings</code>(<strong><code>embeddings</code></strong>, <strong><code>umap_params</code></strong>, <strong><code>fig_size</code></strong>=<em><code>(25, 25)</code></em>)</p>
</blockquote>
<p>Plot 2D embeddings thorugh a connected scatter plot</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embeddings_plot</span> <span class="o">=</span> <span class="n">plot_embeddings</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">umap_params</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Log this plot as part of the current wandb run</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Explainability-with-SHAP-(future-work)">Explainability with SHAP (future work)<a class="anchor-link" href="#Explainability-with-SHAP-(future-work)"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fig = plt.figure(figsize=(10,10))</span>
<span class="c1"># ax = fig.add_subplot(111)</span>

<span class="c1"># ax.scatter(df_embeddings[&#39;x1&#39;], df_embeddings[&#39;x2&#39;], marker=&#39;o&#39;, facecolors=&#39;none&#39;, edgecolors=&#39;b&#39;, alpha=0.1)</span>
<span class="c1"># ax.plot(df_embeddings[&#39;x1&#39;], df_embeddings[&#39;x2&#39;], alpha=0.5, picker=1)</span>
<span class="c1"># ax.set_title(&#39;Select the point you want to visualize as a time window in the original space&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Make the plot interactive to allow selection of subsets of the plot</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># selected_points = None</span>

<span class="c1"># def onpick(event):</span>
<span class="c1">#     global selected_points</span>
<span class="c1">#     thisline = event.artist</span>
<span class="c1">#     xdata = thisline.get_xdata()</span>
<span class="c1">#     ydata = thisline.get_ydata()</span>
<span class="c1">#     global selected_indices</span>
<span class="c1">#     selected_indices = event.ind</span>
<span class="c1">#     selected_points = tuple(zip(xdata[selected_indices], ydata[selected_indices]))</span>
<span class="c1">#     print(&#39;onpick points (first):&#39;, selected_points[0])</span>

<span class="c1"># fig.canvas.mpl_connect(&#39;pick_event&#39;, onpick)</span>

<span class="c1"># plt.show()</span>
<span class="c1"># fig.tight_layout()</span>
<span class="c1"># fig.savefig(f&#39;../img/w={w}.png&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hyperparameter-tuning-for-the-dimensionality-reduction">Hyperparameter tuning for the dimensionality reduction<a class="anchor-link" href="#Hyperparameter-tuning-for-the-dimensionality-reduction"> </a></h2><p>There are a number of parameters that can be set for the UMAP algorithm. The major 
ones are <code>n_neighbors</code> and <code>min_dist</code>. Thus, we will carry out a hyperparameter 
sweep in Weights and Biases for these two parameters. Note that there is no objective
way of deciding that some embeddings are better than others. Thus, we must rely on our
intuition by visualizing the 2D plots of each of the runs in the sweep.</p>
<p>The first thing we need is gather all the pipeline of the previous section into a function</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Linking-back-points-of-the-2D-projection-to-the-original-time-series">Linking back points of the 2D projection to the original time series<a class="anchor-link" href="#Linking-back-points-of-the-2D-projection-to-the-original-time-series"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The variable <code>selected_points</code> and <code>ind</code> contain an array of the points and indices selected in the previous 2D projection. We will take the first of them (there can be many selected points with just one click), and use its index to get the corresponding time window of the original space.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># selected_window</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Visualizing-all-the-variables-in-the-time-window-(default)">Visualizing all the variables in the time window (default)<a class="anchor-link" href="#Visualizing-all-the-variables-in-the-time-window-(default)"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># g = sns.FacetGrid(df_output_tidy, col=&quot;variable&quot;, col_wrap=3, aspect=2)</span>
<span class="c1"># g = g.map(plt.plot, &quot;timestamp&quot;, &quot;value&quot;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Contribution:-Visualize-only-the-most-relevant-variables">Contribution: Visualize only the most relevant variables<a class="anchor-link" href="#Contribution:-Visualize-only-the-most-relevant-variables"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In high dimensional time series, not only is interesting to see the window associated to a point in the 2D space, but also it is extremely important to spot which variables are mainly causing that the window is positioned in that point of the 2D space.</p>
<p>Since UMAP does not provide capabilities to understand feature importance, there are <a href="https://stats.stackexchange.com/questions/438025/understand-important-features-in-umap">different ways</a> to tackle this problem:</p>
<ol>
<li><p>Use another dimensionality reduction technique that provides importance, such as <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.SparsePCA.html">sparse PCA</a></p>
</li>
<li><p>Create a surrogate model on top of the inputs/output of UMAP and explain it using XAI techniques. We will try here this option.</p>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The idea is to have a surrogate model that takes the multivariate time series as input and produces the associated points in the 2D space as ouput. Since we already have a Deep Convolutional Autoencoder (DCAE) that takes a multivariate time series as input, and it contains the latent features that represent that input, we can use it for the surrogate. We will use the intermediate model that goes from the input to the layer containing the latent space, and then add a <code>Dense</code> layer with 2 units and linear activation.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># test.equals(sm.output.shape[1], embeddings.shape[1])</span>
<span class="c1"># l_nms = [layer.name for layer in sm.layers]</span>
<span class="c1"># layer_idx = l_nms.index(&#39;latent_features&#39;)</span>
<span class="c1"># test.all_equal([layer.trainable for layer in sm.layers], \</span>
<span class="c1">#                np.repeat([False, True], [layer_idx + 1, len(sm.layers) -1 -layer_idx]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Configure the training hyperparameters</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># opt = &#39;adam&#39;</span>
<span class="c1"># bs = 100</span>
<span class="c1"># epochs = 10</span>
<span class="c1"># val = .2</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># e = shap.DeepExplainer(intermediate_model, background)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

